@model AdminX.ViewModels.PatientVM

@{
    ViewData["Title"] = "Admin-X - Add New Patient";
    ViewData["Page"] = "/ Add New Patient ";
    ViewData["HomeBtn"] = Html.ActionLink("Back to Home Page", "Index", "Home", new { }, new { @class = "btn btn-primary m-1" });
}

@{
    ViewBag.HomeButton = new[]
    {
        Html.ActionLink("Back to Patient Details", "PatientDetails", "Patient", new { id = Model.patient.MPI }, new { @class = "btn btn-light bg-white me-2 m-1" }),
        
    };
}



<div class="">
    @if (Model.message != null)
    {
        <div class="card">
            <div class="card-header"></div>
            <div class="card-body">
                @if (Model.success)
                {
                    <div class="alert alert-success alert-dismissible" role="alert">
                        <div class="alert-icon">
                            <i class="far fa-fw fa-bell"></i>
                        </div>
                        <div class="alert-message">
                            <h3>@Model.message</h3>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-danger alert-dismissible" role="alert">
                        <div class="alert-icon">
                            <i class="far fa-fw fa-bell"></i>
                        </div>
                        <div class="alert-message">
                            <h3>@Model.message</h3>
                        </div>
                    </div>
                }
            </div>
        </div>
    }


    <div class="card">
        <div class="card-body">
            <form method="post" id="frmEdit" asp-action="EditPatientDetails">
                <div class="row">
                    <div class="mb-3 col-md-3">
                        <label class="form-label">CGU Number</label>
                        <input name="cguNumber" asp-for=@Model.patient.CGU_No readonly />
                        <input name="mpi" asp-for=@Model.patient.MPI hidden />                        
                    </div>
                </div>

                <div class="row">
                    <div class="mb-3 col-md-3">
                        <label class="form-label">Title</label>
                        <select class="form-select" id="ddlTitle" name="title" asp-for=@Model.patient.Title>
                            <option value="" selected></option>
                            @foreach (var item in Model.titles)
                            {
                                <option value=@item.Title>@item.Title</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3 col-md-3">
                        <label class="form-label" for="firstName">First name</label>
                        <input type="text" name="firstName" class="form-control" id="firstName" asp-for=@Model.patient.FIRSTNAME>
                    </div>
                    <div class="mb-3 col-md-3">
                        <label class="form-label" for="secondName">Second name</label>
                        <input type="text" name="secondName" class="form-control" id="secondName" placeholder="Secondname" asp-for=@Model.patient.PtForename2>
                    </div>
                    <div class="mb-3 col-md-3">
                        <label class="form-label" for="lastName">Last name</label>
                        <input type="text" name="lastName" class="form-control" id="lastName" asp-for=@Model.patient.LASTNAME>
                    </div>
                </div>
                <div class="row">
                    <div class="mb-3 col-md-3">
                        <label class="form-label" for="preferredName">Preferred Name</label>
                        <input type="text" name="preferredName" class="form-control" id="preferredName" placeholder="Preferred Name" asp-for=@Model.patient.PtAKA>
                    </div>
                    <div class="mb-3 col-md-3">
                        <label class="form-label" for="dob">Date of Birth</label>
                        <input type="date" name="dob" class="form-control" id="dob" placeholder="Date of Birth" asp-for=@Model.patient.DOB>
                    </div>
                    <div class="mb-3 col-md-3">
                        <label class="form-label" for="dod">Date of death (if applicable)</label>
                        <input type="date" name="DECEASED_DATE" class="form-control" id="dod"
                               placeholder="Date of death (if applicable)"
                               asp-for="@Model.patient.DECEASED_DATE"
                               onchange="CheckDeceasedStatus()">

                    <div  id="deceasedContainer" hidden>
                        <label class="form-label" for="chkDeceased">Confirm Deceased</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="chkDeceased" name="DECEASED" value="1"
                                   @(Model.patient.DECEASED == 1 ? "checked" : "") />
                            <label class="form-check-label" for="chkDeceased">Patient is Deceased</label>
                        </div>
                    </div>
                    </div>
                    <div class="mb-3 col-md-3">
                        <label class="form-label" for="nhsno">NHS Number</label>
                        <input type="text" name="nhsno" class="form-control" id="nhsno" asp-for=@Model.patient.SOCIAL_SECURITY>
                    </div>
                </div>
                <div class="row">
                    <div class="mb-3 col-md-3">
                        <label class="form-label" for="language">Primary Language (if not English)</label>
                        <input type="text" name="language" class="form-control" id="language" asp-for=@Model.patient.PrimaryLanguage>
                    </div>
                    <div class="mb-3 col-md-3">
                        <label class="form-label" for="dob">Interpreter required</label>
                        <select class="form-select" name="isInterpreterReqd">
                            <option value="No" selected="@(Model.patient.IsInterpreterReqd == "No" ? "selected" : null)">No</option>
                            <option value="Yes" selected="@(Model.patient.IsInterpreterReqd == "Yes" ? "selected" : null)">Yes</option>
                        </select>

                    </div>
                    <div class="mb-3 col-md-3">
                        <label class="form-label" for="ethnic">Ethnicity</label>
                        <select class="form-select" name="ethnicCode" asp-for=@Model.patient.EthnicCode>
                            <option value="" selected>Select...</option>

                            @foreach (var item in Model.ethnicities)
                            {
                                <option value=@item.EthnicCode>@item.Ethnic</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3 col-md-3">
                        <label class="form-label" for="sex">Sex</label>
                        <select class="form-select" name="sex" asp-for=@Model.patient.SEX>
                            <option value="" selected>Select...</option>
                            @foreach (var item in Model.genders)
                            {
                                <option value=@item.Sex>@item.Sex</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="mb-3 col-md-3">
                        <label class="form-label" for="ddlGPPractice">GP Details (select a practice to see GP list)</label>
                        <select class="form-select js-choice" id="ddlGPPractice" name="gpPracticeCode" onchange="ShowGPList()" asp-for=@Model.patient.GP_Facility_Code>
                            <option value="" selected>Select...</option>
                            @foreach (var item in Model.GPPracticeList)
                            {
                                <option value=@item.MasterFacilityCode>@item.MasterFacilityCode - @item.NAME, @item.ADDRESS, @item.ZIP</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3 col-md-3" >
                        <label class="form-label" for="ddlGPPractice">Salutation</label>
                        <input type="text" name="SALUTATION" class="form-control" id="SALUTATION" placeholder="Salutation" asp-for=@Model.patient.SALUTATION>
                    </div>
                    <div class="mb-3 col-md-3">
                        <label class="form-label" for="ethnic">Gender Identity</label>
                        <select class="form-select" name="GenderIdentity" asp-for=@Model.patient.GenderIdentity>
                            <option value="" selected>Select...</option>

                            @foreach (var item in Model.genderIdentities)
                            {
                                <option value=@item.Gender>@item.Gender</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="row">                    
                    <div class="mb-3 col-md-3">
                        <select class="form-select" id="ddlGP" name="gpCode" asp-for=@Model.patient.GP_Code>
                            <option value="" selected>Select...</option>
                            @foreach(var item in Model.currentGPList)
                            {
                                <option value=@item.MasterClinicianCode>@item.TITLE @item.FIRST_NAME @item.NAME (@item.MasterClinicianCode)</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="mb-3 col-md-6">
                        <label class="form-label">Address</label>
                        <input type="text" placeholder="Address 1" name="ADDRESS1" class="form-control" id="ADDRESS1" asp-for=@Model.patient.ADDRESS1>
                    </div>
                    <div class="mb-3 col-md-6">
                        <label class="form-label" for="TEL">Contact Number</label>
                        <input type="text" name="TEL" class="form-control" id="TEL" asp-for=@Model.patient.TEL>
                    </div>
                </div>
                <div class="row">
                    <div class="mb-3 col-md-6">
                        <input type="text" placeholder="Address 2" name="ADDRESS2" class="form-control" id="ADDRESS2" asp-for=@Model.patient.ADDRESS2>
                    </div> <div class="mb-3 col-md-6">
                        <label class="form-label" for="Mobile">Mobile</label>
                        <input type="text" name="PtTelMobile" class="form-control" id="Mobile" asp-for=@Model.patient.PtTelMobile>
                    </div>
                </div>
                <div class="row">
                    <div class="mb-3 col-md-6">
                        <input type="text" placeholder="City" name="ADDRESS3" class="form-control" id="ADDRESS3" asp-for=@Model.patient.ADDRESS3>
                    </div>
                    <div class="mb-3 col-md-6">
                        <label class="form-label" for="EmailAddress">Email Address</label>
                        @if (Model.patient.EmailAddress == null)
                        {
                            <input type="text" name="email" class="form-control" id="EmailAddress"  asp-for=@Model.patient.EmailAddressUnconfirmed>
                        }
                        else
                        {
                            <input type="text" name="email" class="form-control" id="EmailAddress" asp-for=@Model.patient.EmailAddress>
                        }
                    </div>
                </div>
                <div class="row">
                    <div class="mb-3 col-md-6">
                        <input type="text" placeholder="County" name="ADDRESS4" class="form-control" id="ADDRESS4"  asp-for=@Model.patient.ADDRESS4>
                    </div>
                    <div class="mb-3 col-md-3">
                        <label class="form-label">Consent to Electronic Communication</label>
                        <select class="form-select" id="IsConsentToEmail" name="isConsentToEmail">
                            <option value="false">No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="mb-3 col-md-6">
                        <input type="text" placeholder="PostCode" name="POSTCODE" class="form-control" id="POSTCODE" asp-for=@Model.patient.POSTCODE>
                    </div>
                </div>

                <div class="row">
                    <div class="mb-3 col-md-6">
                        <label class="form-label">Area Code</label>
                        <select name="areaCode" class="form-select js-choice" id="AreaCode" asp-for="@Model.selectedAreaID"  required>
                            <option value="">Select Area Code</option>
                            @foreach (var item in Model.areaNamesList)
                            {
                                <option value=@item.AreaID>@item.AreaCode - @item.AreaName</option>
                            }
                        </select>
                    </div>
                </div>

                <button type="button" id="btnSubmit" class="btn btn-primary btn-lg">Save Patient</button>
            </form>
        </div>
    </div>    
</div>


<script>

    document.getElementById("ADDRESS3").addEventListener("change", GetCountyFromCity);
    window.addEventListener("load", LoadPatient);
    document.getElementById("btnSubmit").addEventListener("click", DoSubmit);

    function DoSubmit()
    {
        if (CheckFormValid() == 1)
        {
            document.getElementById("frmEdit").submit();
        }
    }

    function CheckFormValid() { //validation to ensure all required data is entered

        if (document.getElementById("ddlTitle").value == null || document.getElementById("ddlTitle").value == "")
        {
            window.alert("Please select a title.");
            return 0;
        }

        if (document.getElementById("firstName").value == null || document.getElementById("lastName").value == "")
        {
            window.alert("Please enter a name.");
            return 0;
        }

        if (document.getElementById("dob").value == null || document.getElementById("dob").value == "")
        {
            window.alert("Please enter a date of birth.");
            return 0;
        }

        if (document.getElementById("nhsno").value == null || document.getElementById("nhsno").value == "")
        {
            window.alert("Please enter a NHS number (if one isn't available, use 0000000000).");
            return 0;
        }

        if (document.getElementById("ddlGP").value == null || document.getElementById("ddlGP").value == "")
        {
            window.alert("Please choose a GP.");
            return 0;
        }

        if (document.getElementById("POSTCODE").value == null || document.getElementById("POSTCODE").value == "")
        {
            window.alert("Please enter a postcode.");
            return 0;
        }

        if (document.getElementById("ADDRESS3").value == null || document.getElementById("ADDRESS3").value == "")
        {
            window.alert("Please enter a city.");
            return 0;
        }

        if (document.getElementById("ADDRESS1").value == null || document.getElementById("ADDRESS1").value == "")
        {
            window.alert("Please enter at least one line of address.");
            return 0;
        }

        if (document.getElementById("AreaCode").value == null || document.getElementById("AreaCode").value == "")
        {
            window.alert("Please choose an area code.");
            return 0;
        }

        return 1;
    }



    function LoadPatient()
    {    
        var areaIDArray = []; //all this is necessary because the MPT only stores the code and the name, not the ID. 
                                //but the code is not a unique key, so there's no way to bind it with asp-for!
                                //we need to ID, and the only way to get the ID and insert it is like this.

        @foreach(var item in Model.areaNamesList)
        {
            if(Model.patient.PtAreaCode == item.AreaCode && Model.patient.PtAreaName == item.AreaName)
            {
                @:areaIDArray.push("@item.AreaID");
            }
        }

        if(areaIDArray.length != 0)
        {
            document.getElementById("AreaCode").value = areaIDArray[0];
        }

        if("@Model.patient.EmailCommsConsent" == "Yes")
        {           
            document.getElementById("IsConsentToEmail").value = "true";
        }
        else
        {
            document.getElementById("IsConsentToEmail").value = "false";
        }
    }
    @*
    function ShowGPList()
    {
        var _practice = document.getElementById("ddlGPPractice");
        var _gp = document.getElementById("ddlGP");
        var options = _gp.options.length - 1;

        for (i = options; i >= 0; i--)
        {
            _gp.remove(i);
        }

        var clinCodeArray = [];
        var clinArray = [];
        var facilityCodeArray = [];

        @foreach (var item in Model.GPList)
        {
            @:clinCodeArray.push("@item.MasterClinicianCode");
            @:clinArray.push("@item.TITLE @item.FIRST_NAME @item.NAME (@item.MasterClinicianCode)");
            @:facilityCodeArray.push("@item.FACILITY");
        }

        for (var i = 0; i < facilityCodeArray.length; i++)
        {
            if(facilityCodeArray[i] != _practice.value)
            {
                delete clinCodeArray[i];
                delete clinArray[i];
            }
        }

        for (var i in clinCodeArray)
        {
            var opt = document.createElement('option');
            opt.value = clinCodeArray[i];
            opt.innerHTML = clinArray[i]
            _gp.appendChild(opt);
        }

        //_gp.value = "@Model.patient.GP_Code";
    }
    *@

        async function ShowGPList()
    {
        var _practice = document.getElementById("ddlGPPractice");
        var _gp = document.getElementById("ddlGP");
        var practiceCode = _practice.value;

        _gp.innerHTML = "";

        if (!practiceCode) {
            
            return;
        }

        try {
            var loadingOpt = document.createElement('option');
            loadingOpt.text = "Loading GPs...";
            _gp.appendChild(loadingOpt);

          
            const response = await fetch(`/Patient/GetGPsByPractice?practiceCode=${practiceCode}`);

            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();

            _gp.innerHTML = "";

            var defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.text = "Select...";
            _gp.appendChild(defaultOpt);

            data.forEach(item => {
                var opt = document.createElement('option');
                opt.value = item.value;
                opt.text = item.text;
                _gp.appendChild(opt);
            });

        } catch (error) {
            console.error('Error fetching GPs:', error);
            _gp.innerHTML = "<option>Error loading list</option>";
        }
    }


    function GetCountyFromCity()
    {
        var city = document.getElementById("ADDRESS3");
        var county = document.getElementById("ADDRESS4");
        var areaCode = document.getElementById("AreaCode");
        var cityUpper = city.value.toUpperCase();
        city.value = cityUpper;
        var cityArray = [];
        var countyArray = [];
        var areaCodeArray = [];

    @foreach (var item in Model.cityList)
    {
        @:cityArray.push("@item.TownCity");
        @:countyArray.push("@item.County");
        @:areaCodeArray.push("@item.AreaCode");
    }

        for (var i in cityArray)
        {
            if(cityArray[i] == cityUpper)
            {
                county.value = countyArray[i];
                areaCode.value = areaCodeArray[i];
            }
        }
    }

    Inputmask("999 999 9999").mask(document.getElementById("nhsno"));

    document.addEventListener('DOMContentLoaded', function() {
        CheckDeceasedStatus();
    });

    function CheckDeceasedStatus() {
        var dodInput = document.getElementById("dod");
        var deceasedContainer = document.getElementById("deceasedContainer");
        var deceasedCheckbox = document.getElementById("chkDeceased");

        if (dodInput.value) {
        
            deceasedContainer.hidden = false;

          
            deceasedCheckbox.setAttribute("required", "");

           
            deceasedCheckbox.checked = true;
        } else {
            deceasedContainer.hidden = true;

            deceasedCheckbox.removeAttribute("required");

            deceasedCheckbox.checked = false;
        }
    }



</script>